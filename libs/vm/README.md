# Monad EVM Compiler

> [!WARNING]  
> This project is an untested work in progress.

An implementation of an [EVMC][evmc]-compatible implementation of the Ethereum
Virtual Machine, using LLVM to compile EVM bytecode to native code for faster
execution. The work in this project is a C++ reimplementation of the
[`monad-jit`][jit] project, with the eventual aim of merging the compiler into
the core Monad monorepo.

## Building & Running

The compiler is built and tested in CI on Ubuntu 24.04. To build locally, first
install the following dependencies via `apt`:
```
build-essential
cmake
llvm-18-dev
libcli11-dev
libgtest-dev
```

Then, from the project root:
```console
$ git submodule update --init --recursive
$ cmake -S . -B build
$ cmake --build build
```

## Testing

### Directory Type Check Test

After building the compiler source code, the `directory-type-check` executable
can be used on a directory containing bytecode contracts. It will recursively
traverse the directory and run the type inference algorithm on all the
contracts. It will additionally run the type checking algorithm to verify the
correctness of the inferred types. For example
```console
build/src/test/utils/directory-type-check my/contracts-dir
```
will print type inference errors to standard error and print contract type
information to standard out. If it prints to standard error, there is bug
somewhere.

### EVMC Tests

To run the EVMC tests, build [EVMC][evmc] following the project documentation:
```console
$ ls
evmc monad-compiler
$ cd evmc
$ cmake -S . -B build -DEVMC_TESTING=On
$ cmake --build build
```

Note that this build of EVMC is **not** the same one used in the
`monad-compiler` submodule; there is a [CMake conflict][hunter] when building
the EVMC test applications as part of our submodule. Instead, use a separate
top-level copy of EVMC alongside `monad-compiler`.

Then, run the VM tester tool against the library built by the compiler project
(presuming that the two projects are in sibling directories):
```console
$ ./build/bin/evmc-vmtester ../monad-compiler/build/src/vm/libmonad-compiler-vm.so
EVMC VM Tester 12.0.0
Testing ../monad-compiler/build/src/vm/libmonad-compiler-vm.so

[==========] Running 10 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 10 tests from evmc_vm_test
[ RUN      ] evmc_vm_test.abi_version_match
[       OK ] evmc_vm_test.abi_version_match (0 ms)
[ RUN      ] evmc_vm_test.name
[       OK ] evmc_vm_test.name (0 ms)
[ RUN      ] evmc_vm_test.version
[       OK ] evmc_vm_test.version (0 ms)
[ RUN      ] evmc_vm_test.capabilities
[       OK ] evmc_vm_test.capabilities (0 ms)
[ RUN      ] evmc_vm_test.execute_call
[       OK ] evmc_vm_test.execute_call (49 ms)
[ RUN      ] evmc_vm_test.execute_create
[       OK ] evmc_vm_test.execute_create (0 ms)
[ RUN      ] evmc_vm_test.set_option_unknown_name
[       OK ] evmc_vm_test.set_option_unknown_name (0 ms)
[ RUN      ] evmc_vm_test.set_option_empty_value
[       OK ] evmc_vm_test.set_option_empty_value (0 ms)
[ RUN      ] evmc_vm_test.set_option_unknown_value
[       OK ] evmc_vm_test.set_option_unknown_value (0 ms)
[ RUN      ] evmc_vm_test.precompile_test
[       OK ] evmc_vm_test.precompile_test (0 ms)
[----------] 10 tests from evmc_vm_test (50 ms total)

[----------] Global test environment tear-down
[==========] 10 tests from 1 test suite ran. (50 ms total)
[  PASSED  ] 10 tests.
```

## Structure

There are four main components:
- A compiler from EVM bytecode to LLVM IR; the programs generated by this
  compiler rely on being linked against a runtime support library, and on being
  run in the context of an EVMC-compatible host.
- A runtime support library for EVM programs that handles interaction with the
  host context (gas calculations etc.).
- An EVMC-compatible VM layer that handles compiling bytecode to LLVM, then
  executing the compiled code via LLVM's JIT implementation.
- A debugging tool that compiles a contract to LLVM IR and dumps the result to
  `stdout`.

## Documentation

To build the project's documentation using [Doxygen][doxygen], run:
```console
$ doxygen
```
from the project root.

On Peach machines, the built documentation needs to be accessed over SSH. To run
a local HTTP server that can be tunneled to your local machine, run:
```console
$ ./scripts/serve-docs.sh
```

Then, on your local machine open an HTTP tunnel over SSH with:
```console
$ ssh -N -L 8000:localhost:8000 <user@some-peach>
```

The documentation is then accessible from `http://localhost:8000` locally.

[doxygen]: https://www.doxygen.nl/
[evmc]: https://github.com/ethereum/evmc
[jit]: https://github.com/monad-crypto/monad-jit
[hunter]: https://github.com/ethereum/evmc/pull/169

## Linting & Formatting

To run the linter, call:
```console
scripts/apply-clang-tidy-fixes.sh build run-clang-tidy-18
```

To apply the formatter, use:
```console
find src/compiler/ -iname '*.h' -o -iname '*.cpp' | xargs clang-format-18 -i
find src/test -iname '*.h' -o -iname '*.cpp' | xargs clang-format-18 -i
```
